<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨æ–¹ä½é€€ä¼‘æº–å‚™åº¦æª¢æ¸¬ | CFP åœ‹éš›ç†è²¡é¡§å• æ—é¦¬ä¸è£½ä½œ</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --primary-color: #0056b3; --accent-color: #f8f9fa; --bg-color: #f4f7f6; --orange-brand: #e65100; }
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background-color: var(--bg-color); color: #333; margin: 0; padding: 20px; overflow-x: hidden; }

        /* === 1. Web View Styles === */
        #mobileAppLayer { display: block; max-width: 800px; margin: 0 auto; background: #ffffff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .app-box { border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .app-title { font-size: 1.25em; font-weight: bold; color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 8px; margin-bottom: 15px; }
        .app-btn { display: block; width: 100%; padding: 15px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 1.15em; margin-top: 15px; cursor: pointer; transition: 0.2s; font-weight: bold; }
        .app-btn:active { transform: scale(0.98); }
        
        .user-info-box { background: #e9f5ff; border: 2px solid #b8daff; padding: 20px; border-radius: 10px; margin-bottom: 25px; }
        .form-label { display: block; font-weight: bold; margin-bottom: 8px; color: #0056b3; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; box-sizing: border-box; }

        .question-row { display: flex; flex-direction: column; margin-bottom: 18px; padding-bottom: 10px; border-bottom: 1px dashed #eee; }
        .input-wrapper { display: flex; align-items: center; margin-top: 10px; }
        input[type="range"] { flex: 1; margin: 0 10px; height: 35px; cursor: pointer; }
        @media(min-width: 600px) { .question-row { flex-direction: row; justify-content: space-between; align-items: flex-start; } .input-wrapper { margin-top: 0; width: 45%; } }

        /* === 2. PDF Print Styles === */
        #pdfPrintLayer { display: none; width: 794px; min-width: 794px; margin: 0 auto; background: #ffffff; }
        .pdf-page { width: 794px; height: 1080px; padding: 50px 60px; box-sizing: border-box; background: white; position: relative; overflow: hidden; border-bottom: 1px solid #eee; }
        .pdf-table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        .pdf-table th, .pdf-table td { border: 1px solid #333; padding: 12px; text-align: center; font-size: 14px; }
        .pdf-table th { background: var(--primary-color); color: white; }
        .chart-box-pdf { position: relative; width: 550px; height: 450px; margin: 20px auto; }
        .page-footer { position: absolute; bottom: 40px; width: 100%; left: 0; text-align: center; color: #999; font-size: 12px; }

        /* UI Overlays */
        #loadingOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); color: white; z-index: 200000; text-align: center; padding-top: 40vh; }
        #mobileDownloadModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200001; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 85%; max-width: 350px; padding: 30px; border-radius: 15px; text-align: center; }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div style="font-size:3.5em; margin-bottom:15px;">ğŸ“Š</div>
    <div style="font-size:1.3em; font-weight:bold; letter-spacing: 2px;">ç³»çµ±æ­£åœ¨ç²¾ç®—æ‚¨çš„é€€ä¼‘è—åœ–...</div>
</div>

<div id="mobileDownloadModal">
    <div class="modal-box">
        <h2 style="margin-top:0; color:#333;">è¨ºæ–·å ±å‘Šè£½ä½œå®Œæˆï¼</h2>
        <p style="color:#666; font-size:0.95em; line-height:1.6;">æ‰‹æ©Ÿç«¯è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•é ˜å–æ‚¨çš„ PDF æ–‡ä»¶ã€‚</p>
        <a id="blobDownloadLink" class="app-btn" style="text-decoration:none; background:#28a745;" target="_blank">ğŸ“¥ ä¸‹è¼‰å®Œæ•´å ±å‘Š</a>
        <button onclick="closeModal()" style="margin-top:18px; border:none; background:none; color:#999; text-decoration:underline; font-size:0.9em;">è¿”å›æª¢æ¸¬çµæœ</button>
    </div>
</div>

<div id="mobileAppLayer">
    <div id="inputSection">
        <h1 style="color:var(--primary-color); text-align:center; margin-bottom:30px;">å…¨æ–¹ä½é€€ä¼‘æº–å‚™åº¦æª¢æ¸¬</h1>
        
        <div class="user-info-box">
            <h3 style="margin-top:0; color:#0056b3; font-size:1.1em;">ğŸ“ æª¢æ¸¬è€…ç™»éŒ„</h3>
            <div class="form-group">
                <label class="form-label">æ‚¨çš„å§“åï¼š</label>
                <input type="text" id="userName" class="form-input" placeholder="è«‹è¼¸å…¥å§“å">
            </div>
            <div class="form-group">
                <label class="form-label">è¯çµ¡é›»è©± (é¸å¡«)ï¼š</label>
                <input type="tel" id="userPhone" class="form-input" placeholder="ä¾‹å¦‚ï¼š0912-345-678">
            </div>
        </div>

        <p style="text-align:center; color:#777; font-size:0.9em; margin-bottom:20px;">è«‹æ ¹æ“šå¯¦éš›ç¾æ³å·¦å³æ»‘å‹•è©•åˆ† (0:ä¸è¶³ ~ 5:å……è¶³)</p>
        <div id="quizContainer"></div>
        <button class="app-btn" onclick="submitAndShowResults()">é€å‡ºä¸¦ç”Ÿæˆåˆ†æçµæœ</button>
    </div>
    
    <div id="resultSection" style="display:none;">
        <h2 style="text-align:center; color:var(--primary-color);">è¨ºæ–·çµæœç¸½è¦½</h2>
        <p id="welcomeUser" style="text-align:center; font-weight:bold; color:#444; margin-bottom:25px;"></p>
        
        <div style="background: var(--accent-color); padding: 30px; text-align: center; border-radius: 12px; margin-bottom: 30px; border: 1px solid #eee;">
            <div style="font-size:1em; color:#666; margin-bottom:10px;">é€€ä¼‘äº”åŠ›ç¶œåˆå¾—åˆ†</div>
            <div style="font-size: 4em; font-weight: bold; color: #d9534f; line-height:1;" id="webTotal">0</div>
        </div>

        <div id="emailCaptureZone" style="background: linear-gradient(135deg, #fff5e6 0%, #fff 100%); border: 2px solid #ff9800; padding: 25px; border-radius: 15px; margin: 30px 0; box-shadow: 0 6px 15px rgba(255,152,0,0.1);">
            <h3 style="margin-top:0; color:#e65100; font-size: 1.25em;">ğŸ“© é ˜å–å¹´é½¡å°ˆå±¬ç™½çš®æ›¸</h3>
            <p style="font-size:0.95em; color:#5d4037; line-height:1.6;"><b>CFP åœ‹éš›ç†è²¡é¡§å• æ—é¦¬ä¸</b> å»ºè­°æ‚¨åŒæ­¥å‚™ä»½å ±å‘Šã€‚æˆ‘å€‘å°‡æ ¹æ“šæ‚¨çš„å¹´é½¡å€æ®µï¼Œé¡å¤–å¯„é€å°ˆå±¬çš„ã€Šé€€ä¼‘è²¡å‹™ç¼ºå£æª¢æŸ¥æ¸…å–®ã€‹ã€‚</p>
            
            <div style="margin-bottom:15px;">
                <label style="display:block; font-size:0.85em; color:#e65100; font-weight:bold; margin-bottom:5px;">æ‚¨çš„å¹´é½¡å€æ®µï¼š</label>
                <select id="userAge" class="form-input" style="border: 2px solid #ddd; background: #fff; cursor: pointer;">
                    <option value="30-40">30-40 æ­² (è³‡ç”¢è¡åˆºæœŸ)</option>
                    <option value="41-50">41-50 æ­² (é»ƒé‡‘å¤¾å¿ƒæœŸ)</option>
                    <option value="51-60">51-60 æ­² (é€€ä¼‘æº–å‚™æœŸ)</option>
                    <option value="61+">61 æ­²ä»¥ä¸Š (æ¨‚æ´»äº«å—æœŸ)</option>
                </select>
            </div>
            
            <div style="display:flex; gap:10px;">
                <input type="email" id="userEmail" class="form-input" placeholder="è«‹è¼¸å…¥é›»å­ä¿¡ç®±" style="flex:2; border: 2px solid #ddd;">
                <button onclick="sendEmailReport()" id="emailBtn" style="flex:1.2; background:#e65100; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">ç«‹å³ç™¼é€</button>
            </div>
            <div id="emailStatus" style="font-size:0.85em; margin-top:12px; font-weight:bold; display:none;"></div>
        </div>
        
        <div id="webAdviceList"></div>
        <div class="chart-box-web" style="height:350px; margin:30px 0;"><canvas id="webRadarChart"></canvas></div>

        <div style="text-align:center; margin:40px 0;">
            <button class="app-btn" style="background:#28a745;" onclick="processPDF()">ğŸ“¥ ä¸‹è¼‰æ­£å¼ PDF è¨ºæ–·æ›¸</button>
            <button class="app-btn" style="background:#6c757d; margin-top:15px;" onclick="location.reload()">ğŸ”„ é‡æ–°æ¸¬é©—</button>
        </div>
    </div>
</div>

<div id="pdfPrintLayer">
    <div class="pdf-page">
        <h2 style="text-align:center; color:#0056b3; margin-top:20px; font-size: 28px;">å…¨æ–¹ä½é€€ä¼‘æº–å‚™åº¦è¨ºæ–·æ›¸</h2>
        <p style="text-align:right; font-size: 13px; color:#666; margin-right:10px;">CFP åœ‹éš›ç†è²¡é¡§å• æ—é¦¬ä¸ è£½ä½œ | <span id="pdfDate"></span></p>
        <div style="margin-top:40px; text-align:center;">
            <p style="font-size:22px; font-weight:bold;">å—æ¸¬å°è±¡ï¼š<span id="pdfUserName"></span> å…ˆç”Ÿ/å°å§</p>
        </div>
        <div style="text-align:center; background:#f8f9fa; padding:40px; margin:50px; border-radius:25px; border:1px solid #eee;">
            <div style="font-size:1.3em; color:#555; margin-bottom:10px;">é€€ä¼‘äº”åŠ›æ ¸å¿ƒæŒ‡æ¨™å¾—åˆ†</div>
            <div style="font-size:7em; font-weight:bold; color:#d9534f; line-height:1;" id="pdfTotal">0</div>
        </div>
        <h3 style="color:#0056b3; border-left:8px solid #0056b3; padding-left:15px; margin-top:60px; font-size:20px;">ç¬¬ä¸€éƒ¨åˆ†ï¼šåˆ†é …æ•¸æ“šè©•ä¼°</h3>
        <table class="pdf-table">
            <thead><tr><th width="40%">æª¢æ¸¬é¢å‘</th><th width="20%">å¾—åˆ†</th><th width="40%">ç‹€æ…‹è©•åˆ†</th></tr></thead>
            <tbody id="pdfTableBody"></tbody>
        </table>
        <div class="page-footer">- ç¬¬ 1 é  -</div>
    </div>
    <div class="pdf-page">
        <h3 style="color:#0056b3; border-left:8px solid #0056b3; padding-left:15px; font-size:20px;">ç¬¬äºŒéƒ¨åˆ†ï¼šå°ˆæ¥­è¡Œå‹•æ–¹é‡</h3>
        <div id="pdfAdviceList" style="margin-top: 30px;"></div>
        <div class="page-footer">- ç¬¬ 2 é  -</div>
    </div>
    <div class="pdf-page">
        <h3 style="color:#0056b3; border-left:8px solid #0056b3; padding-left:15px; font-size:20px;">ç¬¬ä¸‰éƒ¨åˆ†ï¼šäº”åŠ›å‡è¡¡åˆ†æåœ–</h3>
        <div class="chart-box-pdf"><canvas id="pdfRadarChart"></canvas></div>
        <div style="text-align:center; margin-top:100px; padding:30px; border:2px solid #f0f0f0; border-radius:20px; background:#fafafa;">
            <p style="font-size:1.3em; color:#333; font-weight:bold; margin-bottom:15px;">ğŸ’¡ CFP é¡§å•çš„çœŸå¿ƒå»ºè­°</p>
            <p style="color:#555; line-height:1.8; font-size:15px;">
                åˆ†æ•¸çš„é«˜ä½ä¸¦éçµ‚é»ï¼Œè€Œæ˜¯è¡Œå‹•çš„èµ·é»ã€‚<br>
                é€€ä¼‘è¦åŠƒä¸åƒ…æ˜¯æ•¸å­—çš„å¢æ¸›ï¼Œæ›´æ˜¯ç”Ÿæ´»å“è³ªçš„å»¶çºŒã€‚<br>
                <b>CFP åœ‹éš›ç†è²¡é¡§å• æ—é¦¬ä¸</b> å°‡èˆ‡æ‚¨ä¸€åŒå®ˆè­·æ‚¨çš„ç¬¬äºŒäººç”Ÿã€‚
            </p>
        </div>
        <div class="page-footer">- ç¬¬ 3 é  -</div>
    </div>
</div>

<script>
    // === V57.1 æ ¸å¿ƒåŒæ­¥é…ç½® ===
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/æ‚¨çš„æ–°ç¶²å€/exec';

    const questions = {
        finance: { 
            label: "è²¡å‹™åŸºç«™", 
            items: ["è¢«å‹•æ”¶å…¥è¦†è“‹ç‡ (0åˆ†<30% | 5åˆ†>100%)", "ç·Šæ€¥é å‚™é‡‘å……è¶³åº¦ (0åˆ†<3å€‹æœˆ | 5åˆ†>6å€‹æœˆ)", "é†«ç™‚é˜²ç¦¦ä¿‚æ•¸ (0åˆ† ä¸è¶³ | 5åˆ† å……è¶³)", "è² å‚µæ­¸é›¶è¨ˆç•« (0åˆ† ç„¡è¨ˆåŠƒ | 5åˆ† ç„¡è² å‚µ)", "è³‡ç”¢é…ç½®å¤šå…ƒæ€§ (0åˆ† å–®ä¸€ | 5åˆ† å¤šå…ƒ)"] 
        },
        health: { 
            label: "èº«å¿ƒçºŒèˆª", 
            items: ["èº«é«”è³ªé‡æŒ‡æ•¸ (BMI) (0åˆ† ç•°å¸¸ | 5åˆ† æ¨™æº–)", "è‚Œè‚‰é‡èˆ‡è¡Œå‹•åŠ› (0åˆ† è¡°é€€ | 5åˆ† è‰¯å¥½)", "è¦å¾‹é‹å‹•ç¿’æ…£ (0åˆ† ä¸é‹å‹• | 5åˆ† æ¯é€±å¤šæ–¼ä¸‰æ¬¡)", "ç¡çœ å“è³ª (0åˆ† å°æ–¼äº”å°æ™‚ | 5åˆ† å¤šæ–¼ä¸ƒå°æ™‚)", "å®¶æ—ç—…å²è¿½è¹¤ (0åˆ† ç„¡é«”æª¢ç¿’æ…£ | 5åˆ† æ¯å¹´å®šæœŸæª¢æŸ¥)"] 
        },
        social: { 
            label: "ç¤¾äº¤æ¼«éŠ", 
            items: ["éè·å ´æœ‹å‹æ•¸é‡ (0åˆ† å°‘æ–¼ä¸‰äºº | 5åˆ† å¤šæ–¼åäºº)", "è·¨ä»£é€£çµé »ç‡ (0åˆ† ç„¡ | 5åˆ† é »ç¹)", "ç¤¾ç¾¤åƒèˆ‡åº¦ (0åˆ† å­¤ç«‹ | 5åˆ† ç©æ¥µæŠ•å…¥)", "è¦ªå¯†é—œä¿‚å¸³æˆ¶ (0åˆ† ç–é  | 5åˆ† ç·Šå¯†æ”¯æŒ)", "ç·Šæ€¥æ•‘æ´ç¶² (0åˆ† ç„¡å»ºç«‹ | 5åˆ† éš¨æ™‚å¯æ±‚åŠ©)"] 
        },
        purpose: { 
            label: "ç¬¬äºŒäººç”Ÿ", 
            items: ["èº«ä»½èªåŒåˆ‡æ› (0åˆ† ç„¡æ³• | 5åˆ† é †åˆ©è½‰æ›)", "æ™‚é–“çµæ§‹åŒ–èƒ½åŠ› (0åˆ† æ··äº‚ | 5åˆ† äº•ç„¶æœ‰åº)", "å¿ƒæµé«”é©—é »ç‡ (0åˆ† ç„¡ | 5åˆ† ç¶“å¸¸ç™¼ç”Ÿ)", "å­¸ç¿’æ–°æŠ€èƒ½æ„é¡˜ (0åˆ† ç„¡æ„é¡˜ | 5åˆ† æŒçºŒå­¸ç¿’)", "åœ“å¤¢åŸ·è¡ŒåŠ› (0åˆ† æ‹–å»¶ | 5åˆ† ç©æ¥µè¡Œå‹•)"] 
        }
    };

    let webChart = null, pdfChart = null, currentData = [];

    function init() {
        const container = document.getElementById('quizContainer');
        for (let key in questions) {
            let section = document.createElement('div');
            section.className = 'app-box';
            section.innerHTML = `<div class="app-title">${questions[key].label}</div>`;
            questions[key].items.forEach(item => {
                section.innerHTML += `
                    <div class="question-row">
                        <span style="font-size:0.95em; line-height:1.4;">${item}</span>
                        <div class="input-wrapper">
                            <input type="range" min="0" max="5" value="0" data-cat="${key}" oninput="this.nextElementSibling.innerText = this.value">
                            <span style="font-weight:bold; margin-left:12px; width:25px; text-align:center; color:var(--primary-color);">0</span>
                        </div>
                    </div>`;
            });
            container.appendChild(section);
        }
        document.getElementById('pdfDate').innerText = new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
    }

    function getAdvice(score, type) {
        const logic = {
            finance: { low: "è²¡å‹™è­¦æˆ’ã€‚è¢«å‹•æ”¶å…¥åš´é‡ä¸è¶³ï¼Œå»ºè­°å„ªå…ˆå»ºç«‹3å€‹æœˆç·Šæ€¥é å‚™é‡‘ä¸¦å¯©è¦–é«˜åˆ©å‚µå‹™ã€‚", mid: "è³‡ç”¢ç©©å¥ä½†ç¼ºä¹æˆé•·ã€‚å»ºè­°å„ªåŒ–æŠ—é€šè†¨é…ç½®ï¼Œä¸¦é–‹å§‹ä¼°ç®—é€€ä¼‘å¾Œçš„ç²¾ç¢ºç¾é‡‘æµç¼ºå£ã€‚", high: "è²¡å‹™å„ªç•°ã€‚å»ºè­°é€²å…¥å‚³æ‰¿è¦åŠƒéšæ®µï¼Œé€éç¨…å‹™å·¥å…·ç¢ºä¿è³‡ç”¢èƒ½ä¾æ‚¨çš„æ„é¡˜é †åˆ©ç§»è½‰ã€‚" },
            health: { low: "å¥åº·èµ¤å­—ã€‚é€€ä¼‘æœ€å¤§é–‹æ”¯ä¾†è‡ªé†«ç™‚ï¼Œå»ºè­°ç«‹å³é ç´„å…¨èº«å¥æª¢ä¸¦å¾ä½å¼·åº¦æ•£æ­¥é–‹å§‹æ”¹å–„ã€‚", mid: "å¥åº·æŒå¹³ã€‚è‚ŒåŠ›èˆ‡å¿ƒè‚ºåŠŸèƒ½æœ‰è¡°é€€è·¡è±¡ï¼Œå»ºè­°åŠ å…¥é©åº¦é‡è¨“ï¼Œé˜²æ­¢é€€ä¼‘å¾Œè¡Œå‹•åŠ›å—é™ã€‚", high: "æ´»åŠ›å……è¶³ã€‚æ‚¨å…·å‚™æ¥µä½³çš„é€€ä¼‘è³‡æœ¬ï¼Œå»ºè­°ç¶­æŒç¤¾äº¤æ€§é‹å‹•ï¼Œå°‡å¥åº·ç¶“é©—åˆ†äº«çµ¦èº«é‚Šè¦ªå‹ã€‚" },
            social: { low: "ç¤¾äº¤å­¤å³¶ã€‚è·å ´å¤–ç”Ÿæ´»åœˆéçª„ï¼Œå»ºè­°æ¯æœˆä¸»å‹•è¯ç¹«ä¸€ä½è€å‹ï¼Œæˆ–åŠ å…¥æ„Ÿèˆˆè¶£çš„å…¬ç›Šçµ„ç¹”ã€‚", mid: "ç¤¾äº¤ç©©å®šã€‚å»ºè­°å»ºç«‹è·¨ä»£æœ‹å‹åœˆï¼Œä¸¦èˆ‡æ ¸å¿ƒè¦ªå‹å»ºç«‹ç·Šæ€¥äº’åŠ©æ©Ÿåˆ¶ï¼Œç¢ºä¿å¿ƒç†æ”¯æŒç¶²ã€‚", high: "äººéš›æ¨ç´ã€‚æ‚¨æ“æœ‰æ¥µä½³çš„ç¤¾äº¤è³‡æœ¬ï¼Œå»ºè­°é€²è¡Œç¤¾äº¤éæ¿¾ï¼Œå°‡æ™‚é–“ç•™çµ¦çœŸæ­£æ»‹é¤Šå¿ƒéˆçš„æ·±åº¦é—œä¿‚ã€‚" },
            purpose: { low: "é‡å¿ƒç¼ºå¤±ã€‚é€€ä¼‘å¾Œå®¹æ˜“å¤±å»è‡ªæˆ‘å®šä½ï¼Œå»ºè­°å˜—è©¦ã€ä¸æè·ç¨±ã€ä»‹ç´¹è‡ªå·±ï¼Œå°‹æ‰¾ç´”ç²¹çš„æ„›å¥½ã€‚", mid: "æ¢ç´¢æœŸã€‚å·²æœ‰åˆæ­¥èˆˆè¶£ï¼Œå»ºè­°è¨­å®šå…·é«”çš„å°ç›®æ¨™ï¼ˆå¦‚è€ƒç…§ã€å‰µä½œï¼‰ï¼Œå°‡ä¼‘é–’è½‰åŒ–ç‚ºæˆå°±æ„Ÿã€‚", high: "åœ“æ»¿å¯¦ç¾ã€‚ç›®æ¨™æ¸…æ™°ä¸”å…·å‚™åŸ·è¡ŒåŠ›ï¼Œå»ºè­°å•Ÿå‹•ã€å¤§å¸«è¨ˆç•«ã€ï¼Œå°‡æ™ºæ…§å‚³æ‰¿çµ¦ä¸‹ä¸€ä»£æˆ–ç¤¾ç¾¤ã€‚" }
        };
        return score >= 20 ? logic[type].high : (score >= 11 ? logic[type].mid : logic[type].low);
    }

    async function submitAndShowResults() {
        const name = document.getElementById('userName').value.trim();
        if (!name) { alert("è«‹å¡«å¯«æ‚¨çš„å§“åï¼Œä»¥ä¾¿æ—é¦¬ä¸é¡§å•ç‚ºæ‚¨ç”Ÿæˆå€‹äººåŒ–åˆ†æã€‚"); return; }

        document.getElementById('loadingOverlay').style.display = 'block';

        let scores = { finance: 0, health: 0, social: 0, purpose: 0 };
        document.querySelectorAll('input[type="range"]').forEach(input => { scores[input.dataset.cat] += parseInt(input.value); });
        currentData = [scores.finance, scores.health, scores.social, scores.purpose];
        const total = currentData.reduce((a,b)=>a+b, 0);

        // å­˜æª” (V56 åŸå§‹èƒŒæ™¯å‚³é€)
        fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify({ name, phone: document.getElementById('userPhone').value, ...scores, total }),
            mode: 'no-cors'
        });

        document.getElementById('webTotal').innerText = total;
        document.getElementById('pdfTotal').innerText = total;
        document.getElementById('pdfUserName').innerText = name;
        document.getElementById('welcomeUser').innerText = `${name} å…ˆç”Ÿ/å°å§ï¼Œé€™æ˜¯ç‚ºæ‚¨ç²¾æº–æ¸¬ç¹ªçš„é€€ä¼‘åŠ›åœ–è­œï¼š`;

        let adviceHtml = '', pdfTable = '', pdfAdvice = '';
        for(let key in questions) {
            let s = scores[key];
            let color = s>=20?"#28a745":(s>=11?"#d39e00":"#d9534f");
            let status = s>=20?"å„ªè‰¯":(s>=11?"å°šå¯":"éœ€åŠ å¼·");
            adviceHtml += `<div style="border-left:5px solid ${color}; padding:12px; margin-bottom:12px; background:#fff; font-size:0.95em; box-shadow: 2px 2px 5px rgba(0,0,0,0.02);"><b>${questions[key].label}</b>: ${getAdvice(s, key)}</div>`;
            pdfTable += `<tr><td>${questions[key].label}</td><td style="font-weight:bold; font-size:16px;">${s}</td><td style="color:${color};font-weight:bold">${status}</td></tr>`;
            pdfAdvice += `<div style="margin-bottom:20px; padding:15px; background:#fcfcfc; border-left:6px solid ${color};"><div style="font-weight:bold; margin-bottom:8px; color:#333;">${questions[key].label}è©•ä¼°ï¼š${status}</div><div style="font-size:14px; color:#555; line-height:1.6;">${getAdvice(s, key)}</div></div>`;
        }

        document.getElementById('webAdviceList').innerHTML = adviceHtml;
        document.getElementById('pdfTableBody').innerHTML = pdfTable;
        document.getElementById('pdfAdviceList').innerHTML = pdfAdvice;

        if(webChart) webChart.destroy();
        webChart = createChart('webRadarChart', currentData, false);

        setTimeout(() => {
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('inputSection').style.display = 'none';
            document.getElementById('resultSection').style.display = 'block';
            window.scrollTo(0,0);
        }, 1200);
    }

    async function sendEmailReport() {
        const email = document.getElementById('userEmail').value.trim();
        const age = document.getElementById('userAge').value;
        const name = document.getElementById('userName').value.trim();
        const btn = document.getElementById('emailBtn');
        const statusDiv = document.getElementById('emailStatus');

        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            statusDiv.style.display = 'block'; statusDiv.style.color = '#d9534f'; statusDiv.innerText = "âš ï¸ è«‹è¼¸å…¥æ­£ç¢ºçš„ä¿¡ç®±æ ¼å¼ï¼Œä»¥åˆ©ç™½çš®æ›¸ç™¼é€ã€‚"; return;
        }

        btn.disabled = true; btn.style.background = "#999"; btn.innerText = "æ’ç¨‹ä¸­...";
        statusDiv.style.display = 'block'; statusDiv.style.color = '#0056b3'; statusDiv.innerText = "â³ æ­£æ ¹æ“šæ‚¨çš„å¹´é½¡èª¿æ´¾å°ˆå±¬ç™½çš®æ›¸ï¼Œè«‹ç¨å€™...";

        try {
            await fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: "send_email", name, email, age, total: currentData.reduce((a,b)=>a+b,0) }),
                mode: 'no-cors'
            });
            setTimeout(() => {
                statusDiv.style.color = '#28a745';
                statusDiv.innerText = "âœ… å ±å‘Šå·²é ç´„ç™¼é€ï¼è«‹è‡³ä¿¡ç®±æª¢æŸ¥ï¼ˆè‹¥æ²’çœ‹åˆ°è«‹æŸ¥é–±åƒåœ¾éƒµä»¶ï¼‰ã€‚";
                btn.innerText = "å·²æˆåŠŸé ç´„";
            }, 1500);
        } catch (e) {
            btn.disabled = false; btn.style.background = "#e65100"; btn.innerText = "é‡æ–°ç™¼é€";
        }
    }

    function createChart(canvasId, data, isPdf) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        return new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['è²¡å‹™åŠ›', 'å¥åº·åŠ›', 'ç¤¾äº¤åŠ›', 'äººç”ŸåŠ›'],
                datasets: [{ data: data, backgroundColor: 'rgba(0,86,179,0.15)', borderColor: '#0056b3', borderWidth: 2, pointBackgroundColor: '#0056b3', pointRadius: isPdf?5:3 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                animation: isPdf ? false : { duration: 1200 },
                scales: { r: { suggestedMin: 0, suggestedMax: 25, ticks: { display: false }, pointLabels: { font: { size: isPdf?16:13, weight: 'bold' } } } },
                plugins: { legend: { display: false } }
            }
        });
    }

    async function processPDF() {
        document.getElementById('loadingOverlay').style.display = 'block';
        window.scrollTo(0, 0);
        const originalWidth = document.body.style.width;
        
        try {
            document.body.style.width = '794px'; // A4 Standard Width
            document.getElementById('mobileAppLayer').style.display = 'none';
            document.getElementById('pdfPrintLayer').style.display = 'block';

            if(pdfChart) pdfChart.destroy();
            await new Promise(r => setTimeout(r, 100));
            pdfChart = createChart('pdfRadarChart', currentData, true);
            await new Promise(r => setTimeout(r, 1000)); // Buffer for re-rendering

            const opt = {
                margin: 0, filename: `é€€ä¼‘æº–å‚™åº¦è¨ºæ–·æ›¸_${document.getElementById('userName').value}.pdf`, 
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, windowWidth: 794, scrollY: 0 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            const isPhone = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            if (isPhone) {
                const worker = html2pdf().set(opt).from(document.getElementById('pdfPrintLayer'));
                const blob = await worker.output('blob');
                const file = new File([blob], opt.filename, { type: "application/pdf" });
                restoreUI(originalWidth);
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({ files: [file], title: 'æ‚¨çš„é€€ä¼‘è¨ºæ–·å ±å‘Š', text: 'é€™æ˜¯ç”±æ—é¦¬ä¸é¡§å•æä¾›çš„å°ˆæ¥­åˆ†æã€‚' });
                } else {
                    document.getElementById('blobDownloadLink').href = URL.createObjectURL(blob);
                    document.getElementById('mobileDownloadModal').style.display = 'flex';
                }
            } else {
                await html2pdf().set(opt).from(document.getElementById('pdfPrintLayer')).save();
                restoreUI(originalWidth);
            }
        } catch (e) {
            alert('PDF ç”Ÿæˆä¸­æ–·ï¼š' + e.message); restoreUI(originalWidth);
        }
    }

    function restoreUI(width) {
        document.body.style.width = width || '';
        document.getElementById('pdfPrintLayer').style.display = 'none';
        document.getElementById('mobileAppLayer').style.display = 'block';
        document.getElementById('loadingOverlay').style.display = 'none';
        window.scrollTo(0, 0);
    }

    function closeModal() { document.getElementById('mobileDownloadModal').style.display = 'none'; }
    init();
</script>
</body>
</html>
