<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨æ–¹ä½é€€ä¼‘æº–å‚™åº¦æª¢æ¸¬ | æ‚¨çš„å°ˆå±¬CFPé¡§å• æ—é¦¬ä¸è£½ä½œ</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --primary-color: #0056b3; --accent-color: #f8f9fa; --bg-color: #f4f7f6; }
        body { 
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; 
            background-color: var(--bg-color); 
            color: #333; 
            margin: 0; 
            padding: 20px; 
            overflow-x: hidden; 
        }

        /* === 1. äº’å‹•ä»‹é¢ (Web View) === */
        #mobileAppLayer {
            display: block;
            max-width: 800px;
            margin: 0 auto;
            background: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .app-btn { display: block; width: 100%; padding: 15px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 1.2em; margin-top: 25px; cursor: pointer; }
        .app-box { background: #fafafa; border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 8px; }
        .app-title { font-weight: bold; color: var(--primary-color); border-bottom: 2px solid #eee; padding-bottom: 8px; margin-bottom: 12px; font-size: 1.1em; }
        .question-row { display: flex; flex-direction: column; margin-bottom: 12px; }
        .input-wrapper { display: flex; align-items: center; margin-top: 5px; }
        input[type="range"] { flex: 1; margin: 0 10px; height: 30px; }
        @media(min-width: 600px) { 
            .question-row { flex-direction: row; justify-content: space-between; align-items: center; }
            .input-wrapper { margin-top: 0; width: 50%; }
        }
        .web-score-card { background: var(--accent-color); padding: 25px; text-align: center; border-radius: 10px; margin-bottom: 25px; }
        .chart-box-web { position: relative; height: 300px; width: 100%; max-width: 500px; margin: 30px auto; }

        /* === 2. PDF è¼¸å‡ºä»‹é¢ (Print View) === */
        #pdfPrintLayer {
            display: none; 
            width: 794px; /* A4 å¯¬åº¦ */
            min-width: 794px; 
            /* é—œéµï¼šé›–ç„¶é€™è£¡å¯« margin autoï¼Œä½†åœ¨ JS ç”Ÿæˆæ™‚æˆ‘å€‘æœƒå¼·åˆ¶è¦†è“‹æ‰å®ƒ */
            margin: 0 auto; 
            background: #ffffff; 
            padding: 20px 0;
            white-space: normal; 
        }

        .pdf-page {
            width: 794px;
            height: 1080px; /* å›ºå®šé«˜åº¦ */
            padding: 50px 60px;
            box-sizing: border-box;
            background: white;
            position: relative;
            overflow: hidden; 
            margin-bottom: 20px;
            /* å…§å®¹ç½®ä¸­ */
            margin-left: auto;
            margin-right: auto;
            border: 1px solid #eee; 
        }

        .pdf-table { width: 100%; border-collapse: collapse; margin-top: 30px; font-size: 14px; }
        .pdf-table th, .pdf-table td { border: 1px solid #333; padding: 12px; text-align: center; }
        .pdf-table th { background: var(--primary-color); color: white; }
        .chart-box-pdf { position: relative; width: 600px; height: 500px; margin: 30px auto; display: block; }
        .page-footer { position: absolute; bottom: 40px; width: 100%; left: 0; text-align: center; color: #999; font-size: 12px; }

        /* ä¸‹è¼‰ç›¸é—œå…ƒä»¶ */
        #loadingOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); color: white; z-index: 200000; text-align: center; padding-top: 40vh; }
        
        #mobileDownloadModal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 200001; 
            justify-content: center; align-items: center; 
        }
        .modal-box { background: white; width: 85%; max-width: 350px; padding: 25px; border-radius: 15px; text-align: center; }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div style="font-size:3em; margin-bottom:15px;">âš™ï¸</div>
    <div style="font-size:1.2em; font-weight:bold;">å ±å‘Šç”Ÿæˆä¸­...</div>
    <div style="font-size:0.9em; color:#ccc; margin-top:10px;">(ç³»çµ±å°‡è‡ªå‹•èª¿æ•´æ’ç‰ˆï¼Œè«‹ç¨å€™)</div>
</div>

<div id="mobileDownloadModal">
    <div class="modal-box">
        <h2 style="margin-top:0; color:#333;">å ±å‘Šå·²å®Œæˆï¼</h2>
        <p style="color:#666; font-size:0.9em; line-height:1.5;">è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ä¸‹è¼‰ã€‚</p>
        <a id="blobDownloadLink" class="app-btn" style="margin-top:15px; text-decoration:none;" target="_blank" download="é€€ä¼‘æª¢æ¸¬å ±å‘Š.pdf">ğŸ“¥ ä¸‹è¼‰ PDF</a>
        <button onclick="closeModal()" style="margin-top:15px; border:none; background:none; color:#999; text-decoration:underline; cursor:pointer;">é—œé–‰</button>
    </div>
</div>

<div id="mobileAppLayer">
    <div id="inputSection">
        <h1 style="color:#0056b3; text-align:center;">é€€ä¼‘æº–å‚™åº¦æª¢æ¸¬ç«™</h1>
        <p style="text-align:center; color:#666;">è«‹ä¾ç¾æ³è©•åˆ† (0åˆ†:ä¸è¶³ ~ 5åˆ†:å……è¶³)</p>
        <div id="quizContainer"></div>
        <button class="app-btn" onclick="showWebResults()">æŸ¥çœ‹è¨ºæ–·çµæœ</button>
    </div>
    
    <div id="resultSection" style="display:none;">
        <h2 style="text-align:center; color:#0056b3;">è¨ºæ–·çµæœç¸½è¦½</h2>
        <div class="web-score-card">
            <div style="font-size:1.1em; color:#555;">ç¶œåˆè©•ä¼°å¾—åˆ†</div>
            <div style="font-size: 3.5em; font-weight: bold; color: #d9534f; line-height:1.2;" id="webTotal">0</div>
        </div>
        <div id="webAdviceList"></div>
        <h3 style="text-align:center; color:#555; margin-top:40px;">ã€äº”åŠ›åˆ†æé›·é”åœ–ã€‘</h3>
        <div class="chart-box-web"><canvas id="webRadarChart"></canvas></div>
        
        <div style="text-align:center; margin-top:40px; margin-bottom:20px;">
            <button class="app-btn" style="background:#28a745;" onclick="processPDF()">ğŸ“¥ ç”¢ç”Ÿ PDF å ±å‘Š</button>
            <button class="app-btn" style="background:#6c757d; margin-top:15px;" onclick="location.reload()">ğŸ”„ é‡æ–°æ¸¬é©—</button>
        </div>
    </div>
</div>

<div id="pdfPrintLayer">
    <div class="pdf-page">
        <h2 style="text-align:center; color:#0056b3; margin-top:10px; font-size: 24px;">å…¨æ–¹ä½é€€ä¼‘æº–å‚™åº¦è¨ºæ–·æ›¸</h2>
        <p style="text-align:right; color:#666; font-size: 12px;">è¨ºæ–·æ—¥æœŸï¼š<span id="pdfDate"></span></p>
        <div style="text-align:center; background:#f8f9fa; padding:20px; margin:20px 50px; border-radius:15px;">
            <div style="font-size:1.2em; color:#555;">ç¶œåˆè©•ä¼°å¾—åˆ†</div>
            <div style="font-size:5em; font-weight:bold; color:#d9534f; line-height:1;" id="pdfTotal">0</div>
        </div>
        <h3 style="color:#0056b3; border-left:6px solid #0056b3; padding-left:12px; margin-top:50px; font-size: 18px;">ç¬¬ä¸€éƒ¨åˆ†ï¼šè©³ç´°å¾—åˆ†</h3>
        <table class="pdf-table"><thead><tr><th width="40%">æª¢æ¸¬é¢å‘</th><th width="20%">å¾—åˆ†</th><th width="40%">ç‹€æ…‹è©•ä¼°</th></tr></thead><tbody id="pdfTableBody"></tbody></table>
        <div class="page-footer">- ç¬¬ 1 é  / å…± 3 é  -</div>
    </div>
    <div class="pdf-page">
        <h3 style="color:#0056b3; border-left:6px solid #0056b3; padding-left:12px; margin-top:10px; font-size: 18px;">ç¬¬äºŒéƒ¨åˆ†ï¼šå°ˆå±¬è¡Œå‹•æ–¹é‡</h3>
        <div id="pdfAdviceList" style="margin-top: 20px;"></div>
        <div class="page-footer">- ç¬¬ 2 é  / å…± 3 é  -</div>
    </div>
    <div class="pdf-page">
        <h3 style="color:#0056b3; border-left:6px solid #0056b3; padding-left:12px; margin-top:10px; font-size: 18px;">ç¬¬ä¸‰éƒ¨åˆ†ï¼šäº”åŠ›åˆ†æè¦–è¦ºåŒ–</h3>
        <div style="text-align:center; margin-top: 30px; color:#666; font-size: 14px;">ä¸‹åœ–å±•ç¤ºäº†æ‚¨åœ¨å››å¤§é¢å‘çš„å¹³è¡¡ç‹€æ…‹</div>
        <div class="chart-box-pdf"><canvas id="pdfRadarChart"></canvas></div>
        <div style="text-align:center; margin-top:60px; color:#555; font-size:12px; border: 1px solid #eee; padding: 15px; border-radius: 10px;">
            <p><strong>æœ¬å ±å‘Šç”±ã€Œå…¨æ–¹ä½é€€ä¼‘æº–å‚™åº¦æª¢æ¸¬ç³»çµ±ã€ç”Ÿæˆ</strong></p>
            <p>æ•¸æ“šåƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›è¦åŠƒå»ºè­°é ç´„ CFP é¡§å• <strong>æ—é¦¬ä¸</strong> é€²è¡Œæ·±åº¦è§£è®€ã€‚</p>
        </div>
        <div class="page-footer">- ç¬¬ 3 é  / å…± 3 é  -</div>
    </div>
</div>

<script>
    const questions = {
        finance: { label: "è²¡å‹™åŸºç«™", items: ["è¢«å‹•æ”¶å…¥è¦†è“‹ç‡", "ç·Šæ€¥é å‚™é‡‘å……è¶³åº¦", "é†«ç™‚é˜²ç¦¦ä¿‚æ•¸", "è² å‚µæ­¸é›¶è¨ˆç•«", "è³‡ç”¢é…ç½®å¤šå…ƒæ€§"] },
        health: { label: "èº«å¿ƒçºŒèˆª", items: ["èº«é«”è³ªé‡æŒ‡æ•¸ (BMI)", "è‚Œè‚‰é‡èˆ‡è¡Œå‹•åŠ›", "è¦å¾‹é‹å‹•ç¿’æ…£", "ç¡çœ å“è³ª", "å®¶æ—ç—…å²è¿½è¹¤"] },
        social: { label: "ç¤¾äº¤æ¼«éŠ", items: ["éè·å ´æœ‹å‹æ•¸é‡", "è·¨ä»£é€£çµé »ç‡", "ç¤¾ç¾¤åƒèˆ‡åº¦", "è¦ªå¯†é—œä¿‚å¸³æˆ¶", "ç·Šæ€¥æ•‘æ´ç¶²"] },
        purpose: { label: "ç¬¬äºŒäººç”Ÿ", items: ["èº«ä»½èªåŒåˆ‡æ›", "æ™‚é–“çµæ§‹åŒ–èƒ½åŠ›", "å¿ƒæµé«”é©—é »ç‡", "å­¸ç¿’æ–°æŠ€èƒ½æ„é¡˜", "åœ“å¤¢åŸ·è¡ŒåŠ›"] }
    };

    let webChart = null, pdfChart = null;
    let currentData = []; 

    function init() {
        const container = document.getElementById('quizContainer');
        for (let key in questions) {
            let section = document.createElement('div');
            section.className = 'app-box';
            section.innerHTML = `<div class="app-title">${questions[key].label}</div>`;
            questions[key].items.forEach(item => {
                section.innerHTML += `
                    <div class="question-row">
                        <span style="flex:1; font-size:0.95em;">${item}</span>
                        <div class="input-wrapper">
                            <input type="range" min="0" max="5" value="0" data-cat="${key}" oninput="this.nextElementSibling.innerText = this.value">
                            <span style="font-weight:bold; margin-left:10px; width:20px; text-align:center;">0</span>
                        </div>
                    </div>`;
            });
            container.appendChild(section);
        }
        document.getElementById('pdfDate').innerText = new Date().toLocaleDateString();
    }

    function getAdvice(score, type) {
        const logic = {
            finance: { low: "è¢«å‹•æ”¶å…¥ä¸è¶³ï¼Œå»ºè­°åŸ·è¡Œå‚µå‹™é›ªçƒæ³•ä¸¦å­˜æ»¿é å‚™é‡‘ã€‚", mid: "è³‡ç”¢æŠ—é€šè†¨åŠ›è„†å¼±ï¼Œå»ºè­°è£œè¶³é†«ç™‚ç¼ºå£ã€‚", high: "è²¡å‹™è‡ªç”±ï¼Œå»ºè­°è«®è©¢ä¿¡è¨—æˆ–å‚³æ‰¿è¦åŠƒã€‚" },
            health: { low: "å¥åº·æœ‰éš±æ†‚ï¼Œè«‹é ç´„å¥æª¢ä¸¦é–‹å§‹æ¯æ—¥é‹å‹•ã€‚", mid: "è‚ŒåŠ›æµå¤±é¢¨éšªï¼Œå»ºè­°å¢åŠ é˜»åŠ›è¨“ç·´ã€‚", high: "é«”æ³æ¥µä½³ï¼Œå»ºè­°æŒ‘æˆ°è…¦é«”å”èª¿é‹å‹•ã€‚" },
            social: { low: "ç”Ÿæ´»åœˆå°é–‰ï¼Œå»ºè­°åƒåŠ å¯¦é«”èˆˆè¶£ç¤¾åœ˜ã€‚", mid: "é€£çµæ·±åº¦ä¸è¶³ï¼Œå»ºè­°å»ºç«‹ç·Šæ€¥äº’åŠ©ç¶²ã€‚", high: "äººè„ˆå»£é—Šï¼Œå»ºè­°å°ˆæ³¨æ–¼æ·±åº¦é—œä¿‚ã€‚" },
            purpose: { low: "åƒ¹å€¼è¿·æƒ˜ï¼Œè«‹åˆ—å‡ºèˆˆè¶£é€²è¡Œä½æˆæœ¬è©¦éŒ¯ã€‚", mid: "ç¼ºä¹åŸ·è¡ŒåŠ›ï¼Œè«‹è¨­å®šå…·é«”å­¸ç¿’ç›®æ¨™ã€‚", high: "ç›®æ¨™æ¸…æ™°ï¼Œè«‹å•Ÿå‹•åœ“å¤¢è¨ˆç•«æˆ–ç¶“é©—å‚³æ‰¿ã€‚" }
        };
        let level = score >= 20 ? 'high' : (score >= 11 ? 'mid' : 'low');
        return logic[type][level];
    }

    function createChart(canvasId, data, isPdf) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        return new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['è²¡å‹™', 'å¥åº·', 'ç¤¾äº¤', 'äººç”Ÿ'],
                datasets: [{ label: 'å¾—åˆ†', data: data, backgroundColor: 'rgba(0,86,179,0.2)', borderColor: '#0056b3', borderWidth: 2, pointBackgroundColor: '#0056b3', pointRadius: isPdf ? 3 : 4 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                animation: isPdf ? false : { duration: 1000 },
                scales: { r: { suggestedMin: 0, suggestedMax: 25, pointLabels: { font: { size: isPdf ? 14 : 12 } }, ticks: { display: !isPdf, stepSize: 5 } } },
                plugins: { legend: { display: false } }
            }
        });
    }

    function showWebResults() {
        let scores = { finance: 0, health: 0, social: 0, purpose: 0 };
        document.querySelectorAll('input[type="range"]').forEach(input => { scores[input.dataset.cat] += parseInt(input.value); });
        currentData = [scores.finance, scores.health, scores.social, scores.purpose];
        
        const total = currentData.reduce((a,b)=>a+b, 0);
        document.getElementById('webTotal').innerText = total;
        document.getElementById('pdfTotal').innerText = total;

        let adviceHtml = '', pdfTable = '', pdfAdvice = '';
        for(let key in questions) {
            let s = scores[key];
            let color = s>=20?"green":(s>=11?"#d39e00":"#d9534f");
            let status = s>=20?"å„ªè‰¯":(s>=11?"å°šå¯":"åŠ æ²¹");
            adviceHtml += `<div style="border-left:4px solid ${color}; padding:10px; margin-bottom:10px; background:#fff;"><b>${questions[key].label}</b>: ${getAdvice(s, key)}</div>`;
            pdfTable += `<tr><td>${questions[key].label}</td><td style="font-weight:bold;">${s}</td><td style="color:${color};font-weight:bold">${status}</td></tr>`;
            pdfAdvice += `<div class="pdf-text" style="margin-bottom:15px; padding:10px; background:#f9f9f9; border-left:4px solid ${color};"><div style="font-weight:bold; margin-bottom:5px;">${questions[key].label} (${status})</div>${getAdvice(s, key)}</div>`;
        }

        document.getElementById('webAdviceList').innerHTML = adviceHtml;
        document.getElementById('pdfTableBody').innerHTML = pdfTable;
        document.getElementById('pdfAdviceList').innerHTML = pdfAdvice;

        document.getElementById('inputSection').style.display = 'none';
        document.getElementById('resultSection').style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });

        if(webChart) webChart.destroy();
        webChart = createChart('webRadarChart', currentData, false);
    }

    // === V52.0 æœ€çµ‚ç‰ˆæ ¸å¿ƒï¼šçµ±ä¸€è¦–çª—æ¨™æº–åŒ– (Standardized Viewport) ===
    async function processPDF() {
        // 1. æº–å‚™éšæ®µ
        document.getElementById('loadingOverlay').style.display = 'block';
        // [é—œéµ] å¼·åˆ¶æ»¾å‹•åˆ° (0,0)ï¼Œé€™æ˜¯æˆªåœ–æº–ç¢ºçš„ç¬¬ä¸€æ­¥
        window.scrollTo(0, 0); 

        // 2. å‚™ä»½ Body åŸå§‹æ¨£å¼
        const originalWidth = document.body.style.width;
        const originalPadding = document.body.style.padding;
        const originalMargin = document.body.style.margin;

        try {
            // 3. [æ ¸å¿ƒä¿®æ­£] å¼·åˆ¶é–å®šè¦–çª—å¯¬åº¦ç‚º 794px
            // ç„¡è«–æ˜¯å¯¬è¢å¹•é›»è…¦é‚„æ˜¯çª„è¢å¹•æ‰‹æ©Ÿï¼Œæ­¤åˆ»é€šé€šè®Šæˆæ¨™æº– A4 å¯¬åº¦
            // é€™è§£æ±ºäº†é›»è…¦ç‰ˆè£åˆ‡ (ä¸å†æœ‰ç•™ç™½) å’Œ æ‰‹æ©Ÿç‰ˆæ“ å£“ (å¼·åˆ¶å±•é–‹)
            document.body.style.width = '794px';
            document.body.style.padding = '0';
            document.body.style.margin = '0'; // ç¢ºä¿é å·¦å°é½Š
            
            // 4. åˆ‡æ›é¡¯ç¤º
            document.getElementById('mobileAppLayer').style.display = 'none';
            const pdfLayer = document.getElementById('pdfPrintLayer');
            pdfLayer.style.display = 'block';
            // ç¢ºä¿ PDF å±¤ä¹Ÿæ²’æœ‰ margin
            pdfLayer.style.margin = '0';

            // 5. é‡ç¹ªåœ–è¡¨ (ç¢ºä¿å¯è¦‹)
            if(pdfChart) pdfChart.destroy();
            await new Promise(r => setTimeout(r, 100)); 
            pdfChart = createChart('pdfRadarChart', currentData, true);
            // ç­‰å¾…æ¸²æŸ“ç·©è¡
            await new Promise(r => setTimeout(r, 800));

            // 6. è¨­å®šæˆªåœ–åƒæ•¸
            const fileName = `é€€ä¼‘æª¢æ¸¬å ±å‘Š_${Date.now()}.pdf`;
            const opt = {
                margin: 0,
                filename: fileName,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    useCORS: true, 
                    scrollY: 0, 
                    windowWidth: 794, // é…åˆ body å¯¬åº¦
                    x: 0, y: 0 // å¾çµ•å°é›¶é»é–‹å§‹æŠ“
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                enableLinks: false
            };

            // 7. åŸ·è¡Œç”Ÿæˆ
            const isPhone = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            if (isPhone) {
                // æ‰‹æ©Ÿç‰ˆï¼šWeb Share / Blob Link
                const worker = html2pdf().set(opt).from(pdfLayer);
                const blob = await worker.output('blob');
                const file = new File([blob], fileName, { type: "application/pdf" });

                // ç”Ÿæˆå®Œç•¢ï¼Œå…ˆé‚„åŸä»‹é¢
                restoreUI(originalWidth, originalPadding, originalMargin);

                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({
                            files: [file],
                            title: 'é€€ä¼‘æº–å‚™åº¦å ±å‘Š',
                            text: 'é€™æ˜¯æ‚¨çš„å…¨æ–¹ä½é€€ä¼‘æº–å‚™åº¦è¨ºæ–·æ›¸ã€‚'
                        });
                    } catch (shareError) {}
                } else {
                    const url = URL.createObjectURL(blob);
                    document.getElementById('blobDownloadLink').href = url;
                    document.getElementById('blobDownloadLink').download = fileName;
                    document.getElementById('mobileDownloadModal').style.display = 'flex';
                }

            } else {
                // é›»è…¦ç‰ˆï¼šç›´æ¥ä¸‹è¼‰
                await html2pdf().set(opt).from(pdfLayer).save();
                
                // é‚„åŸä»‹é¢
                restoreUI(originalWidth, originalPadding, originalMargin);
                alert('ä¸‹è¼‰æˆåŠŸï¼');
            }

        } catch (e) {
            alert('è£½ä½œå¤±æ•—ï¼š' + e.message);
            restoreUI(originalWidth, originalPadding, originalMargin);
        }
    }

    function closeModal() {
        document.getElementById('mobileDownloadModal').style.display = 'none';
    }

    function restoreUI(width, padding, margin) {
        // é‚„åŸæ‰€æœ‰å¼·åˆ¶æ¨£å¼
        document.body.style.width = width || '';
        document.body.style.padding = padding || '20px';
        document.body.style.margin = margin || '';
        
        const pdfLayer = document.getElementById('pdfPrintLayer');
        pdfLayer.style.display = 'none';
        pdfLayer.style.margin = '0 auto'; // é‚„åŸé è¦½ç½®ä¸­
        
        document.getElementById('mobileAppLayer').style.display = 'block';
        document.getElementById('loadingOverlay').style.display = 'none';
        
        window.scrollTo(0, 0);
    }

    init();
</script>

</body>
</html>
