<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨æ–¹ä½é€€ä¼‘æº–å‚™åº¦æª¢æ¸¬ | CFP åœ‹éš›ç†è²¡é¡§å• æ—é¦¬ä¸è£½ä½œ</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --primary-color: #0056b3; --accent-color: #f8f9fa; --bg-color: #f4f7f6; }
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background-color: var(--bg-color); margin: 0; padding: 20px; overflow-x: hidden; }

        /* Web UI */
        #mobileAppLayer { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; z-index: 1; }
        .app-box { border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .app-title { font-size: 1.2em; font-weight: bold; color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 5px; margin-bottom: 15px; }
        .app-btn { display: block; width: 100%; padding: 15px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 1.1em; margin-top: 15px; cursor: pointer; font-weight: bold; text-align: center; }
        .user-info-box { background: #e9f5ff; border: 1px solid #b8daff; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; margin-top: 5px; box-sizing: border-box; }
        
        /* ä¿®æ­£ï¼šé›»è©±éŒ¯èª¤æç¤º */
        .error-msg { color: #d9534f; font-size: 0.9em; display: none; margin-top: 5px; }

        .question-row { display: flex; flex-direction: column; margin-bottom: 15px; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
        .input-wrapper { display: flex; align-items: center; margin-top: 5px; }
        input[type="range"] { flex: 1; margin: 0 10px; }
        @media(min-width: 600px) { .question-row { flex-direction: row; justify-content: space-between; } .input-wrapper { width: 45%; margin-top: 0; } }

        /* PDF æ¸²æŸ“å±¤ï¼šæ”¹ç‚º display:none é è¨­ï¼Œç”Ÿæˆæ™‚å¼·åˆ¶ block ä¸¦è¦†è“‹æœ€ä¸Šå±¤ */
        #pdfPrintLayer { 
            display: none; 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 794px !important; 
            min-width: 794px !important; 
            background: white; 
            z-index: 99999; /* å¼·åˆ¶ç½®é ‚ï¼Œç¢ºä¿ html2canvas çµ•å°çœ‹å¾—åˆ° */
        }
        .pdf-page { width: 794px; height: 1080px; padding: 50px 60px; box-sizing: border-box; background: white; position: relative; overflow: hidden; border-bottom: 1px solid #eee; }
        .pdf-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .pdf-table th, .pdf-table td { border: 1px solid #333; padding: 8px; text-align: center; }
        .chart-box-pdf { width: 550px; height: 450px; margin: 20px auto; }
        
        #loadingOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: white; z-index: 100000; text-align: center; padding-top: 40vh; }
    </style>
</head>
<body>

<div id="loadingOverlay">ğŸ“Š <div style="margin-top:10px;">æ­£åœ¨ç”Ÿæˆå ±å‘Šï¼Œç•«é¢é–ƒçˆç‚ºæ­£å¸¸ç¾è±¡...</div></div>

<div id="mobileAppLayer">
    <div id="inputSection">
        <h2 style="color:var(--primary-color); text-align:center;">é€€ä¼‘æº–å‚™åº¦æª¢æ¸¬ç«™</h2>
        <div class="user-info-box">
            <label>æ‚¨çš„å§“å (å¿…å¡«)ï¼š</label>
            <input type="text" id="userName" class="form-input" placeholder="è«‹è¼¸å…¥å§“å">
            
            <label style="margin-top:10px; display:block;">è¯çµ¡é›»è©± (å¿…å¡«)ï¼š</label>
            <input type="tel" id="userPhone" class="form-input" placeholder="09xxxxxxxx">
            <div id="phoneError" class="error-msg">âš ï¸ è«‹è¼¸å…¥æ­£ç¢ºçš„ 10 ç¢¼æ‰‹æ©Ÿè™Ÿç¢¼</div>
        </div>
        <div id="quizContainer"></div>
        <button class="app-btn" onclick="submitAndShowResults()">é€å‡ºä¸¦æŸ¥çœ‹è¨ºæ–·çµæœ</button>
    </div>

    <div id="resultSection" style="display:none;">
        <h2 style="text-align:center; color:var(--primary-color);">è¨ºæ–·åˆ†æçµæœ</h2>
        <div style="background: #f8f9fa; padding: 20px; text-align: center; border-radius: 12px; margin-bottom: 20px; border: 1px solid #ddd;">
            <div style="font-size: 0.9em; color: #666;">ç¶œåˆè©•ä¼°å¾—åˆ†</div>
            <div id="webTotal" style="font-size: 4em; font-weight: bold; color: #d9534f;">0</div>
        </div>
        
        <div id="webAdviceList"></div>
        <div style="height:320px; margin:20px 0;"><canvas id="webRadarChart"></canvas></div>

        <div id="emailCaptureZone" style="background: #fff5e6; border: 2px solid #ff9800; padding: 20px; border-radius: 12px; margin: 30px 0;">
            <h3 style="color:#e65100; margin-top:0;">ğŸ“© é ˜å–å¹´é½¡å°ˆå±¬ç™½çš®æ›¸</h3>
            <select id="userAge" class="form-input" style="margin-bottom:10px;">
                <option value="30-40">30-40 æ­²</option><option value="41-50">41-50 æ­²</option><option value="51-60">51-60 æ­²</option><option value="61+">61 æ­²ä»¥ä¸Š</option>
            </select>
            <div style="display:flex; gap:10px;">
                <input type="email" id="userEmail" class="form-input" placeholder="è«‹è¼¸å…¥ Email"><button onclick="sendEmailReport()" id="emailBtn" style="background:#e65100; color:white; border:none; padding:0 15px; border-radius:5px; font-weight:bold;">ç™¼é€</button>
            </div>
            <div id="emailStatus" style="font-size:0.85em; margin-top:8px; display:none;"></div>
        </div>

        <button class="app-btn" style="background:#28a745;" onclick="processPDF()">ğŸ“¥ ä¸‹è¼‰æ­£å¼ PDF è¨ºæ–·æ›¸</button>
        <button class="app-btn" style="background:#6c757d; margin-top:10px;" onclick="location.reload()">ğŸ”„ é‡æ–°æ¸¬é©—</button>
    </div>
</div>

<div id="pdfPrintLayer">
    <div class="pdf-page">
        <h2 style="text-align:center; color:#0056b3;">é€€ä¼‘æº–å‚™åº¦è¨ºæ–·æ›¸</h2>
        <p style="text-align:right; font-size:12px;">é¡§å•ï¼šCFP åœ‹éš›ç†è²¡é¡§å• æ—é¦¬ä¸ | <span id="pdfDate"></span></p>
        <div style="text-align:center; margin-top:30px;"><p style="font-size:20px; font-weight:bold;">å—æ¸¬è€…ï¼š<span id="pdfUserName"></span></p></div>
        <div style="text-align:center; background:#f8f9fa; padding:30px; margin:30px 50px; border-radius:20px; border:1px solid #ddd;">
            <div style="font-size:5em; font-weight:bold; color:#d9534f;" id="pdfTotal">0</div>
        </div>
        <table class="pdf-table"><thead><tr><th>é¢å‘</th><th>å¾—åˆ†</th><th>è©•ä¼°</th></tr></thead><tbody id="pdfTableBody"></tbody></table>
    </div>
    <div class="pdf-page"><h3>ç¬¬äºŒéƒ¨åˆ†ï¼šè¡Œå‹•æ–¹é‡</h3><div id="pdfAdviceList"></div></div>
    <div class="pdf-page"><h3>ç¬¬ä¸‰éƒ¨åˆ†ï¼šåˆ†æåœ–è­œ</h3><div class="chart-box-pdf"><canvas id="pdfRadarChart"></canvas></div></div>
</div>

<script>
    // === V57.7 é‡è¦ï¼šè«‹å†æ¬¡ç¢ºèªæ‚¨çš„ URL ===
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyT-p9PEm0y3axjz6oXvYFORBDSQxCqJq_4RrLYdXeko5JHyudkpPuRrSkHaTAwXNLD/exec';
    
    // V56 å®Œæ•´å…§å®¹ (ä¿ç•™)
    const questions = {
        finance: { label: "è²¡å‹™åŸºç«™", items: ["è¢«å‹•æ”¶å…¥è¦†è“‹ç‡ (0åˆ†<30% | 5åˆ†>100%)", "ç·Šæ€¥é å‚™é‡‘å……è¶³åº¦", "é†«ç™‚é˜²ç¦¦ä¿‚æ•¸", "è² å‚µæ­¸é›¶è¨ˆç•«", "è³‡ç”¢é…ç½®å¤šå…ƒæ€§"] },
        health: { label: "èº«å¿ƒçºŒèˆª", items: ["BMI ç‹€æ…‹", "è‚Œè‚‰é‡èˆ‡è¡Œå‹•åŠ›", "è¦å¾‹é‹å‹•ç¿’æ…£", "ç¡çœ å“è³ª", "å®šæœŸæª¢æŸ¥ç¿’æ…£"] },
        social: { label: "ç¤¾äº¤æ¼«éŠ", items: ["éè·å ´æœ‹å‹æ•¸é‡", "è·¨ä»£é€£çµé »ç‡", "ç¤¾ç¾¤åƒèˆ‡åº¦", "è¦ªå¯†é—œä¿‚å¸³æˆ¶", "ç·Šæ€¥æ•‘æ´ç¶²"] },
        purpose: { label: "ç¬¬äºŒäººç”Ÿ", items: ["èº«ä»½èªåŒåˆ‡æ›", "æ™‚é–“çµæ§‹åŒ–èƒ½åŠ›", "å¿ƒæµé«”é©—é »ç‡", "å­¸ç¿’æ–°æŠ€èƒ½æ„é¡˜", "åœ“å¤¢åŸ·è¡ŒåŠ›"] }
    };

    function getAdvice(score, type) {
        const logic = {
            finance: { low: "ç”Ÿå­˜ç„¦æ…®æœŸï¼šè¢«å‹•æ”¶å…¥åš´é‡ä¸è¶³ã€‚å»ºè­°å„ªå…ˆåŸ·è¡Œå‚µå‹™é›ªçƒæ³•ã€‚", mid: "è³‡ç”¢ç´¯ç©æœŸï¼šå»ºè­°è£œè¶³é†«ç™‚ç¼ºå£ã€‚", high: "è²¡å¯Œå‚³æ‰¿æœŸï¼šè²¡å‹™è‡ªç”±ã€‚å»ºè­°è«®è©¢ä¿¡è¨—æ¶æ§‹ã€‚" },
            health: { low: "å¥åº·å´©å£æœŸï¼šè«‹ç«‹å³é ç´„å¥æª¢ã€‚", mid: "äºå¥åº·èª¿æ•´æœŸï¼šå»ºè­°æ¯é€±è‡³å°‘ 2 æ¬¡é˜»åŠ›è¨“ç·´ã€‚", high: "æ¨‚æ´»é•·å£½æœŸï¼šå»ºè­°æŒçºŒæŒ‘æˆ°æ–°é‹å‹•ã€‚" },
            social: { low: "å­¤å³¶æ•ˆæ‡‰æœŸï¼šå»ºè­°åƒåŠ èˆˆè¶£ç¤¾åœ˜ã€‚", mid: "ç¤¾äº¤é‡çµ„æœŸï¼šå»ºè­°å»ºç«‹ç·Šæ€¥äº’åŠ©è¯çµ¡ç¶²ã€‚", high: "ç¤¾ç¾¤æ¨ç´æœŸï¼šå»ºè­°é€²è¡Œç¤¾äº¤æ–·æ¨é›¢ã€‚" },
            purpose: { low: "å¤±å»é‡åŠ›æœŸï¼šç·´ç¿’ã€ä¸æè·ç¨±ã€ä»‹ç´¹è‡ªå·±ã€‚", mid: "æ¢ç´¢å®šéŒ¨æœŸï¼šè¨­å®šå…·é«”å­¸ç¿’ç›®æ¨™ã€‚", high: "è‡ªæˆ‘å¯¦ç¾æœŸï¼šå³åˆ»å•Ÿå‹•åœ“å¤¢å¤§è¨ˆç•«ã€‚" }
        };
        let level = score >= 20 ? 'high' : (score >= 11 ? 'mid' : 'low');
        return logic[type][level];
    }

    let webChart = null, pdfChart = null, currentData = [];

    function init() {
        const container = document.getElementById('quizContainer');
        for (let key in questions) {
            let section = document.createElement('div'); section.className = 'app-box';
            section.innerHTML = `<div class="app-title">${questions[key].label}</div>`;
            questions[key].items.forEach(item => {
                section.innerHTML += `<div class="question-row"><span>${item}</span><div class="input-wrapper"><input type="range" min="0" max="5" value="0" data-cat="${key}" oninput="this.nextElementSibling.innerText = this.value"><span>0</span></div></div>`;
            });
            container.appendChild(section);
        }
        document.getElementById('pdfDate').innerText = new Date().toLocaleDateString();
    }

    async function submitAndShowResults() {
        const name = document.getElementById('userName').value.trim();
        const phone = document.getElementById('userPhone').value.trim();
        const phoneError = document.getElementById('phoneError');
        
        // ä¿®æ­£ 1: é›»è©±é©—è­‰é‚è¼¯
        if (!name) { alert("è«‹å¡«å¯«å§“å"); return; }
        // é©—è­‰æ ¼å¼ï¼š09 é–‹é ­ï¼Œå¾Œé¢æ¥ 8 ä½æ•¸å­—
        const phoneRegex = /^09\d{8}$/;
        if (!phoneRegex.test(phone)) {
            phoneError.style.display = 'block';
            alert("è«‹è¼¸å…¥æ­£ç¢ºçš„å°ç£æ‰‹æ©Ÿæ ¼å¼ (ä¾‹å¦‚ï¼š0912345678)");
            document.getElementById('userPhone').focus();
            return;
        } else {
            phoneError.style.display = 'none';
        }

        document.getElementById('loadingOverlay').style.display = 'block';

        let scores = { finance: 0, health: 0, social: 0, purpose: 0 };
        document.querySelectorAll('input[type="range"]').forEach(input => { scores[input.dataset.cat] += parseInt(input.value); });
        currentData = [scores.finance, scores.health, scores.social, scores.purpose];
        const total = currentData.reduce((a,b)=>a+b, 0);

        // æ•¸æ“šæ”¶é›†ï¼šåŠ å…¥ phone æ¬„ä½å‚³é€
        fetch(GOOGLE_SCRIPT_URL, { 
            method: "POST", mode: 'no-cors', 
            body: JSON.stringify({ name, phone: phone, ...scores, total }) 
        });

        document.getElementById('webTotal').innerText = total;
        document.getElementById('pdfTotal').innerText = total;
        document.getElementById('pdfUserName').innerText = name;
        
        let adviceHtml = '', pdfTable = '', pdfAdvice = '';
        for(let key in questions) {
            let s = scores[key];
            let status = s>=20?"å„ªè‰¯":(s>=11?"å°šå¯":"åŠ æ²¹");
            adviceHtml += `<div><b>${questions[key].label}</b>: ${getAdvice(s, key)}</div>`;
            pdfTable += `<tr><td>${questions[key].label}</td><td>${s}</td><td>${status}</td></tr>`;
            pdfAdvice += `<div><b>${questions[key].label}</b><br>${getAdvice(s, key)}</div>`;
        }
        document.getElementById('webAdviceList').innerHTML = adviceHtml;
        document.getElementById('pdfTableBody').innerHTML = pdfTable;
        document.getElementById('pdfAdviceList').innerHTML = pdfAdvice;

        if(webChart) webChart.destroy();
        webChart = createChart('webRadarChart', currentData, false);
        setTimeout(() => { document.getElementById('inputSection').style.display = 'none'; document.getElementById('resultSection').style.display = 'block'; document.getElementById('loadingOverlay').style.display = 'none'; window.scrollTo(0,0); }, 1000);
    }

    async function processPDF() {
        document.getElementById('loadingOverlay').style.display = 'block';
        window.scrollTo(0, 0); // å›åˆ°é ‚ç«¯
        await new Promise(r => setTimeout(r, 200));
        
        const originalWidth = document.body.style.width;
        const pdfLayer = document.getElementById('pdfPrintLayer');
        
        try {
            // ä¿®æ­£ 2: ç½®é ‚è¦†è“‹æ³• (è§£æ±ºçˆ†ç™½)
            // ä¸å†éš±è—åœ¨ -9999pxï¼Œè€Œæ˜¯ç›´æ¥è“‹åœ¨ç•«é¢ä¸Šï¼Œä¿è­‰ html2canvas æŠ“å¾—åˆ°
            document.body.style.width = '794px'; 
            pdfLayer.style.display = 'block';
            pdfLayer.style.zIndex = '99999'; // æœ€é«˜å±¤ç´š
            
            if(pdfChart) pdfChart.destroy();
            pdfChart = createChart('pdfRadarChart', currentData, true);
            
            // çµ¦äºˆæ¸²æŸ“ç·©è¡æ™‚é–“
            await new Promise(r => setTimeout(r, 1500)); 

            const opt = { 
                margin: 0, 
                filename: `é€€ä¼‘å ±å‘Š.pdf`, 
                image: { type: 'jpeg', quality: 0.98 }, 
                html2canvas: { scale: 2, useCORS: true, windowWidth: 794, scrollX: 0, scrollY: 0 }, 
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
            };

            const isPhone = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            if (isPhone) {
                // æ‰‹æ©Ÿï¼šWeb Share API
                const blob = await html2pdf().set(opt).from(pdfLayer).output('blob');
                const file = new File([blob], "é€€ä¼‘å ±å‘Š.pdf", { type: "application/pdf" });
                restoreUI(originalWidth); // å…ˆå¾©åŸç•«é¢
                if (navigator.share) await navigator.share({ files: [file] });
                else { 
                    const url = URL.createObjectURL(blob);
                    window.open(url, '_blank'); // å‚™ç”¨æ–¹æ¡ˆ
                }
            } else {
                // é›»è…¦ï¼šç›´æ¥ä¸‹è¼‰
                await html2pdf().set(opt).from(pdfLayer).save();
                restoreUI(originalWidth);
            }
        } catch (e) { alert("PDF Error: " + e); restoreUI(originalWidth); }
    }

    function createChart(canvasId, data, isPdf) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        return new Chart(ctx, { type: 'radar', data: { labels: ['è²¡å‹™', 'å¥åº·', 'ç¤¾äº¤', 'äººç”Ÿ'], datasets: [{ data, backgroundColor: 'rgba(0,86,179,0.2)', borderColor: '#0056b3', borderWidth: 2 }] }, options: { animation: isPdf?false:{duration:1000}, scales: { r: { suggestedMin: 0, suggestedMax: 25, ticks: { display: false } } }, plugins: { legend: { display: false } } } });
    }

    async function sendEmailReport() {
        const email = document.getElementById('userEmail').value;
        const btn = document.getElementById('emailBtn');
        if(!email.includes('@')) { alert("Email æ ¼å¼æœ‰èª¤"); return; }
        btn.disabled = true; btn.innerText = "...";
        try {
            await fetch(GOOGLE_SCRIPT_URL, { method: "POST", mode: 'no-cors', body: JSON.stringify({ action: "send_email", name: document.getElementById('userName').value, email, age: document.getElementById('userAge').value, total: currentData.reduce((a,b)=>a+b,0), finance: currentData[0], health: currentData[1], social: currentData[2], purpose: currentData[3] }) });
            document.getElementById('emailStatus').innerText = "âœ… å·²é ç´„ç™¼é€"; document.getElementById('emailStatus').style.display = "block";
        } catch (e) { btn.disabled = false; }
    }

    function restoreUI(width) {
        document.body.style.width = width || '';
        document.getElementById('pdfPrintLayer').style.display = 'none'; // éš±è—å›å»
        document.getElementById('loadingOverlay').style.display = 'none';
        window.scrollTo(0,0);
    }
    init();
</script>
</body>
</html>
