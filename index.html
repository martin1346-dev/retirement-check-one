<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨æ–¹ä½é€€ä¼‘æº–å‚™åº¦æª¢æ¸¬ | CFP åœ‹éš›ç†è²¡é¡§å• æ—é¦¬ä¸è£½ä½œ</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --primary-color: #0056b3; --accent-color: #f8f9fa; --bg-color: #f4f7f6; --orange-brand: #e65100; }
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background-color: var(--bg-color); color: #333; margin: 0; padding: 20px; overflow-x: hidden; }

        /* === 1. äº’å‹•ä»‹é¢ (Web View) === */
        #mobileAppLayer { display: block; max-width: 800px; margin: 0 auto; background: #ffffff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .app-box { border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .app-title { font-size: 1.2em; font-weight: bold; color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 5px; margin-bottom: 15px; }
        .app-btn { display: block; width: 100%; padding: 15px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 1.2em; margin-top: 15px; cursor: pointer; transition: transform 0.1s; font-weight: bold; }
        .app-btn:active { transform: scale(0.98); }
        
        .user-info-box { background: #e9f5ff; border: 2px solid #b8daff; padding: 20px; border-radius: 10px; margin-bottom: 25px; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-weight: bold; margin-bottom: 5px; color: #0056b3; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; box-sizing: border-box; }

        .question-row { display: flex; flex-direction: column; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #eee; }
        .input-wrapper { display: flex; align-items: center; margin-top: 8px; }
        input[type="range"] { flex: 1; margin: 0 10px; height: 30px; cursor: pointer; }
        @media(min-width: 600px) { .question-row { flex-direction: row; justify-content: space-between; align-items: center; } .input-wrapper { margin-top: 0; width: 50%; } }

        /* === 2. PDF è¼¸å‡ºä»‹é¢ (éš±è—å±¤) === */
        #pdfPrintLayer { display: none; width: 794px; min-width: 794px; margin: 0 auto; background: #ffffff; }
        .pdf-page { width: 794px; height: 1080px; padding: 50px 60px; box-sizing: border-box; background: white; position: relative; overflow: hidden; border-bottom: 1px solid #eee; }
        .pdf-table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        .pdf-table th, .pdf-table td { border: 1px solid #333; padding: 12px; text-align: center; }
        .pdf-table th { background: var(--primary-color); color: white; }
        .chart-box-pdf { position: relative; width: 600px; height: 500px; margin: 30px auto; }
        .page-footer { position: absolute; bottom: 40px; width: 100%; left: 0; text-align: center; color: #999; font-size: 12px; }

        /* å…ƒä»¶æ§åˆ¶ */
        #loadingOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); color: white; z-index: 200000; text-align: center; padding-top: 40vh; }
        #mobileDownloadModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200001; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 85%; max-width: 350px; padding: 25px; border-radius: 15px; text-align: center; }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div style="font-size:3em; margin-bottom:15px;">ğŸ“Š</div>
    <div id="loadingText" style="font-size:1.2em; font-weight:bold;">æ­£åœ¨åˆ†ææ•¸æ“š...</div>
</div>

<div id="mobileDownloadModal">
    <div class="modal-box">
        <h2 style="margin-top:0; color:#333;">å ±å‘Šå·²å®Œæˆï¼</h2>
        <p style="color:#666; font-size:0.9em;">è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•å„²å­˜ PDFã€‚</p>
        <a id="blobDownloadLink" class="app-btn" style="text-decoration:none; background:#28a745;" target="_blank">ğŸ“¥ ä¸‹è¼‰ PDF</a>
        <button onclick="closeModal()" style="margin-top:15px; border:none; background:none; color:#999; text-decoration:underline;">è¿”å›</button>
    </div>
</div>

<div id="mobileAppLayer">
    <div id="inputSection">
        <h1 style="color:var(--primary-color); text-align:center;">é€€ä¼‘æº–å‚™åº¦æª¢æ¸¬ç«™</h1>
        <div class="user-info-box">
            <h3 style="margin-top:0; color:#0056b3;">ğŸ“ æª¢æ¸¬è€…è³‡æ–™</h3>
            <div class="form-group">
                <label class="form-label">æ‚¨çš„å§“åï¼š</label>
                <input type="text" id="userName" class="form-input" placeholder="ä¾‹å¦‚ï¼šæ—å¤§æ˜">
            </div>
            <div class="form-group">
                <label class="form-label">è¯çµ¡é›»è©± (é¸å¡«)ï¼š</label>
                <input type="tel" id="userPhone" class="form-input" placeholder="ä¾‹å¦‚ï¼š0912-345-678">
            </div>
        </div>
        <p style="text-align:center; color:#666; margin-bottom:20px;">è«‹ä¾ç¾æ³è©•åˆ† (0:æ¥µåº¦ä¸è¶³ ~ 5:éå¸¸å……è¶³)</p>
        <div id="quizContainer"></div>
        <button class="app-btn" onclick="submitAndShowResults()">æŸ¥çœ‹è¨ºæ–·çµæœ</button>
    </div>
    
    <div id="resultSection" style="display:none;">
        <h2 style="text-align:center; color:var(--primary-color);">è¨ºæ–·çµæœç¸½è¦½</h2>
        <p id="welcomeUser" style="text-align:center; font-weight:bold;"></p>
        
        <div style="background: var(--accent-color); padding: 25px; text-align: center; border-radius: 10px; margin-bottom: 25px;">
            <div style="font-size:1.1em; color:#555;">ç¶œåˆè©•ä¼°å¾—åˆ†</div>
            <div style="font-size: 3.5em; font-weight: bold; color: #d9534f;" id="webTotal">0</div>
        </div>

        <div id="emailCaptureZone" style="background: linear-gradient(135deg, #fff5e6 0%, #fff 100%); border: 2px solid #ff9800; padding: 25px; border-radius: 15px; margin: 30px 0; box-shadow: 0 4px 12px rgba(255,152,0,0.15);">
            <h3 style="margin-top:0; color:#e65100; font-size: 1.2em;">ğŸ“© é ˜å–å®¢è£½åŒ–é€€ä¼‘ç™½çš®æ›¸</h3>
            <p style="font-size:0.9em; color:#5d4037; line-height:1.5;"><b>CFP åœ‹éš›ç†è²¡é¡§å• æ—é¦¬ä¸</b> å°‡ä¾æ“šæ‚¨çš„å¹´é½¡ï¼Œå¯„é€å°ˆå±¬çš„ã€Šé€€ä¼‘è²¡å‹™ç¼ºå£æª¢æŸ¥è¡¨ã€‹è‡³æ‚¨çš„ä¿¡ç®±ã€‚</p>
            <div style="margin-bottom:12px;">
                <label style="display:block; font-size:0.85em; color:#e65100; font-weight:bold; margin-bottom:5px;">æ‚¨çš„å¹´é½¡å€æ®µï¼š</label>
                <select id="userAge" class="form-input" style="border: 2px solid #ddd; background: #fff;">
                    <option value="30-40">30-40 æ­² (è³‡ç”¢è¡åˆºæœŸ)</option>
                    <option value="41-50">41-50 æ­² (é»ƒé‡‘å¤¾å¿ƒæœŸ)</option>
                    <option value="51-60">51-60 æ­² (é€€ä¼‘æº–å‚™æœŸ)</option>
                    <option value="61+">61 æ­²ä»¥ä¸Š (æ¨‚æ´»äº«å—æœŸ)</option>
                </select>
            </div>
            <div style="display:flex; gap:10px;">
                <input type="email" id="userEmail" class="form-input" placeholder="æ‚¨çš„é›»å­ä¿¡ç®±" style="flex:2; border: 2px solid #ddd;">
                <button onclick="sendEmailReport()" id="emailBtn" style="flex:1; background:#e65100; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">ç«‹å³ç™¼é€</button>
            </div>
            <div id="emailStatus" style="font-size:0.85em; margin-top:10px; font-weight:bold; display:none;"></div>
        </div>
        
        <div id="webAdviceList"></div>
        <div class="chart-box-web" style="height:300px; margin:30px 0;"><canvas id="webRadarChart"></canvas></div>

        <div style="text-align:center; margin-top:40px;">
            <button class="app-btn" style="background:#28a745;" onclick="processPDF()">ğŸ“¥ ä¸‹è¼‰ PDF å ±å‘Š</button>
            <button class="app-btn" style="background:#6c757d; margin-top:15px;" onclick="location.reload()">ğŸ”„ é‡æ–°æ¸¬é©—</button>
        </div>
    </div>
</div>

<div id="pdfPrintLayer">
    <div class="pdf-page">
        <h2 style="text-align:center; color:#0056b3; margin-top:10px; font-size: 26px;">å…¨æ–¹ä½é€€ä¼‘æº–å‚™åº¦è¨ºæ–·æ›¸</h2>
        <p style="text-align:right; font-size: 12px; color:#666;">å°ˆæ¥­è«®è©¢ï¼šCFP åœ‹éš›ç†è²¡é¡§å• æ—é¦¬ä¸ | æ—¥æœŸï¼š<span id="pdfDate"></span></p>
        <p style="text-align:center; font-size:20px; font-weight:bold; margin-top:30px;">æª¢æ¸¬è€…ï¼š<span id="pdfUserName"></span></p>
        <div style="text-align:center; background:#f8f9fa; padding:30px; margin:40px 50px; border-radius:20px;">
            <div style="font-size:1.2em; color:#555;">ç¶œåˆè©•ä¼°å¾—åˆ†</div>
            <div style="font-size:6em; font-weight:bold; color:#d9534f; line-height:1;" id="pdfTotal">0</div>
        </div>
        <h3 style="color:#0056b3; border-left:6px solid #0056b3; padding-left:12px; margin-top:60px;">ç¬¬ä¸€éƒ¨åˆ†ï¼šåˆ†é …æ•¸æ“šè©•ä¼°</h3>
        <table class="pdf-table">
            <thead><tr><th width="40%">æª¢æ¸¬é¢å‘</th><th width="20%">å¾—åˆ†</th><th width="40%">ç‹€æ…‹è©•ä¼°</th></tr></thead>
            <tbody id="pdfTableBody"></tbody>
        </table>
        <div class="page-footer">- ç¬¬ 1 é  -</div>
    </div>
    <div class="pdf-page">
        <h3 style="color:#0056b3; border-left:6px solid #0056b3; padding-left:12px;">ç¬¬äºŒéƒ¨åˆ†ï¼šå°ˆå±¬è¡Œå‹•æ–¹é‡</h3>
        <div id="pdfAdviceList" style="margin-top: 30px;"></div>
        <div class="page-footer">- ç¬¬ 2 é  -</div>
    </div>
    <div class="pdf-page">
        <h3 style="color:#0056b3; border-left:6px solid #0056b3; padding-left:12px;">ç¬¬ä¸‰éƒ¨åˆ†ï¼šäº”åŠ›å‡è¡¡åˆ†æ</h3>
        <div class="chart-box-pdf"><canvas id="pdfRadarChart"></canvas></div>
        <div style="text-align:center; margin-top:80px; padding:20px; border:2px solid #eee; border-radius:15px; background:#fafafa;">
            <p style="font-size:1.2em; color:#333; font-weight:bold; margin-bottom:10px;">ğŸ’¡ é¡§å•è²¼å¿ƒæé†’</p>
            <p style="color:#666; line-height:1.6;">æ•¸æ“šåƒ…èƒ½å‘ˆç¾ç¾ç‹€ï¼Œè²¡å‹™è‡ªç”±éœ€è¦æ™‚é–“èˆ‡å°ˆæ¥­çš„ç²¾ç®—ã€‚<br>æœ¬å ±å‘Šç”± <b>CFP åœ‹éš›ç†è²¡é¡§å• æ—é¦¬ä¸</b> ç‚ºæ‚¨å®ˆè­·ã€‚</p>
        </div>
        <div class="page-footer">- ç¬¬ 3 é  -</div>
    </div>
</div>

<script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyT-p9PEm0y3axjz6oXvYFORBDSQxCqJq_4RrLYdXeko5JHyudkpPuRrSkHaTAwXNLD/exec';

    const questions = {
        finance: { label: "è²¡å‹™åŸºç«™", items: ["è¢«å‹•æ”¶å…¥è¦†è“‹ç‡", "ç·Šæ€¥é å‚™é‡‘å……è¶³åº¦", "é†«ç™‚é˜²ç¦¦ä¿‚æ•¸", "è² å‚µæ­¸é›¶è¨ˆç•«", "è³‡ç”¢é…ç½®å¤šå…ƒæ€§"] },
        health: { label: "èº«å¿ƒçºŒèˆª", items: ["èº«é«”è³ªé‡æŒ‡æ•¸ (BMI)", "è‚Œè‚‰é‡èˆ‡è¡Œå‹•åŠ›", "è¦å¾‹é‹å‹•ç¿’æ…£", "ç¡çœ å“è³ª", "å®¶æ—ç—…å²è¿½è¹¤"] },
        social: { label: "ç¤¾äº¤æ¼«éŠ", items: ["éè·å ´æœ‹å‹æ•¸é‡", "è·¨ä»£é€£çµé »ç‡", "ç¤¾ç¾¤åƒèˆ‡åº¦", "è¦ªå¯†é—œä¿‚å¸³æˆ¶", "ç·Šæ€¥æ•‘æ´ç¶²"] },
        purpose: { label: "ç¬¬äºŒäººç”Ÿ", items: ["èº«ä»½èªåŒåˆ‡æ›", "æ™‚é–“çµæ§‹åŒ–èƒ½åŠ›", "å¿ƒæµé«”é©—é »ç‡", "å­¸ç¿’æ–°æŠ€èƒ½æ„é¡˜", "åœ“å¤¢åŸ·è¡ŒåŠ›"] }
    };

    let webChart = null, pdfChart = null, currentData = [];

    function init() {
        const container = document.getElementById('quizContainer');
        for (let key in questions) {
            let section = document.createElement('div');
            section.className = 'app-box';
            section.innerHTML = `<div class="app-title">${questions[key].label}</div>`;
            questions[key].items.forEach(item => {
                section.innerHTML += `
                    <div class="question-row">
                        <span style="font-size:0.95em;">${item}</span>
                        <div class="input-wrapper">
                            <input type="range" min="0" max="5" value="0" data-cat="${key}" oninput="this.nextElementSibling.innerText = this.value">
                            <span style="font-weight:bold; margin-left:10px; width:20px;">0</span>
                        </div>
                    </div>`;
            });
            container.appendChild(section);
        }
        document.getElementById('pdfDate').innerText = new Date().toLocaleDateString();
    }

    function getAdvice(score, type) {
        const logic = {
            finance: { low: "è²¡å‹™è­¦å ±ï¼è¢«å‹•æ”¶å…¥åš´é‡ä¸è¶³ï¼Œå»ºè­°å„ªå…ˆå»ºç«‹3-6å€‹æœˆç·Šæ€¥é å‚™é‡‘ä¸¦å¯©è¦–é«˜åˆ©è²¸ã€‚", mid: "ä¸­ç”¢é™·é˜±é¢¨éšªã€‚å»ºè­°å¼·åŒ–è³‡ç”¢æŠ—é€šè†¨é…ç½®ï¼Œä¸¦è¦åŠƒé€€ä¼‘å¾Œçš„ç¾é‡‘æµæ¨¡å‹ã€‚", high: "è²¡å‹™ç©©å¥ã€‚å»ºè­°é€²å…¥è³‡ç”¢å‚³æ‰¿è¦åŠƒæœŸï¼Œå„ªåŒ–ç¨…å‹™æ¶æ§‹ä»¥é”æˆè·¨ä»£å‚³æ‰¿ã€‚" },
            health: { low: "å¥åº·éš±æ†‚ã€‚é€€ä¼‘å¾Œé†«ç™‚æ”¯å‡ºå°‡æ¿€å¢ï¼Œå»ºè­°ç«‹å³é€²è¡Œå…¨é¢é«”æª¢ä¸¦å¾ä½å¼·åº¦é‹å‹•é–‹å§‹ã€‚", mid: "ç¶­æŒç¾æ³ã€‚è‚ŒåŠ›èˆ‡é«”èƒ½æœ‰é€€åŒ–è¶¨å‹¢ï¼Œå»ºè­°åŠ å…¥é˜»åŠ›è¨“ç·´ä»¥é é˜²è‚Œå°‘ç—‡ã€‚", high: "æ´»åŠ›å……æ²›ã€‚å»ºè­°ç¶­æŒé«˜è³ªé‡ç¤¾äº¤é‹å‹•ï¼Œä¸¦å°‡å¥åº·ç®¡ç†ç¶“é©—åˆ†äº«çµ¦å®¶äººã€‚" },
            social: { low: "å­¤ç¨é¢¨éšªé«˜ã€‚è·å ´å¤–ç¤¾äº¤åœˆéçª„ï¼Œå»ºè­°åŠ å…¥è‡³å°‘å…©å€‹éè·æ¥­ç›¸é—œçš„èˆˆè¶£ç¤¾åœ˜ã€‚", mid: "ç¤¾äº¤ç©©å®šã€‚å»ºè­°å»ºç«‹è·¨ä»£çš„æœ‹å‹åœˆï¼Œè®“æ€è€ƒä¿æŒéˆæ´»ä¸¦å»ºç«‹ç·Šæ€¥äº’åŠ©ç¾¤çµ„ã€‚", high: "ç¤¾äº¤è±å¯Œã€‚æ‚¨æ˜¯ç¤¾ç¾¤ä¸­çš„é—œéµäººç‰©ï¼Œå»ºè­°ç²¾é¸å„ªè³ªé—œä¿‚ï¼Œæ·±åº¦ç¶“ç‡Ÿå¿ƒéˆä¼´ä¾¶ã€‚" },
            purpose: { low: "åƒ¹å€¼è¿·æƒ˜ã€‚å»ºè­°å°‹æ‰¾ç¬¬äºŒæ›²ç·šï¼Œåˆ—å‡ºä¸‰å€‹æ‚¨å¹´è¼•æ™‚æƒ³åšå»æ²’åšçš„äº‹ä¸¦ç«‹å³å˜—è©¦ã€‚", mid: "æ¢ç´¢æœŸã€‚å·²ç¶“æœ‰åˆæ­¥ç›®æ¨™ï¼Œå»ºè­°å°‡èˆˆè¶£è½‰åŒ–ç‚ºè¦å¾‹çš„è¨ˆç•«ï¼ˆå¦‚è€ƒå–è­‰ç…§æˆ–å‰µä½œï¼‰ã€‚", high: "ç”Ÿå‘½åŠ›åœ“æ»¿ã€‚ç›®æ¨™æ¸…æ™°ä¸”å…·å‚™åŸ·è¡ŒåŠ›ï¼Œå»ºè­°å•Ÿå‹•å‚³æ‰¿è¨ˆç•«ï¼Œå½±éŸ¿æ›´å¤šç”Ÿå‘½ã€‚" }
        };
        return score >= 20 ? logic[type].high : (score >= 11 ? logic[type].mid : logic[type].low);
    }

    async function submitAndShowResults() {
        const name = document.getElementById('userName').value.trim();
        if (!name) { alert("è«‹å¡«å¯«å§“åä»¥åˆ©å ±å‘Šç”Ÿæˆã€‚"); return; }

        document.getElementById('loadingOverlay').style.display = 'block';

        let scores = { finance: 0, health: 0, social: 0, purpose: 0 };
        document.querySelectorAll('input[type="range"]').forEach(input => { scores[input.dataset.cat] += parseInt(input.value); });
        currentData = [scores.finance, scores.health, scores.social, scores.purpose];
        const total = currentData.reduce((a,b)=>a+b, 0);

        // èƒŒæ™¯å‚³é€åŸºæœ¬è³‡æ–™ (V56 åŸå§‹é‚è¼¯)
        fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify({ name, phone: document.getElementById('userPhone').value, ...scores, total }),
            mode: 'no-cors'
        }).catch(e => console.error(e));

        document.getElementById('webTotal').innerText = total;
        document.getElementById('pdfTotal').innerText = total;
        document.getElementById('pdfUserName').innerText = name;
        document.getElementById('welcomeUser').innerText = `ä½ å¥½ï¼Œ${name}ï¼ä»¥ä¸‹æ˜¯æ‚¨çš„æ·±åº¦è¨ºæ–·å ±å‘Šï¼š`;

        let adviceHtml = '', pdfTable = '', pdfAdvice = '';
        for(let key in questions) {
            let s = scores[key];
            let color = s>=20?"#28a745":(s>=11?"#d39e00":"#d9534f");
            let status = s>=20?"å„ªè‰¯":(s>=11?"å°šå¯":"éœ€åŠ å¼·");
            adviceHtml += `<div style="border-left:4px solid ${color}; padding:10px; margin-bottom:10px; background:#fff; font-size:0.9em;"><b>${questions[key].label}</b>: ${getAdvice(s, key)}</div>`;
            pdfTable += `<tr><td>${questions[key].label}</td><td style="font-weight:bold;">${s}</td><td style="color:${color};font-weight:bold">${status}</td></tr>`;
            pdfAdvice += `<div style="margin-bottom:15px; padding:15px; background:#f9f9f9; border-left:5px solid ${color}; font-size:14px;"><div style="font-weight:bold; margin-bottom:5px;">${questions[key].label} (${status})</div>${getAdvice(s, key)}</div>`;
        }

        document.getElementById('webAdviceList').innerHTML = adviceHtml;
        document.getElementById('pdfTableBody').innerHTML = pdfTable;
        document.getElementById('pdfAdviceList').innerHTML = pdfAdvice;

        if(webChart) webChart.destroy();
        webChart = createChart('webRadarChart', currentData, false);

        setTimeout(() => {
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('inputSection').style.display = 'none';
            document.getElementById('resultSection').style.display = 'block';
            window.scrollTo(0,0);
        }, 800);
    }

    // === V57.1: å°ˆå±¬éƒµä»¶è‡ªå‹•åŒ–åˆ†æµç™¼é€ ===
    async function sendEmailReport() {
        const email = document.getElementById('userEmail').value.trim();
        const age = document.getElementById('userAge').value;
        const name = document.getElementById('userName').value.trim();
        const btn = document.getElementById('emailBtn');
        const statusDiv = document.getElementById('emailStatus');

        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            statusDiv.style.display = 'block'; statusDiv.style.color = '#d9534f'; statusDiv.innerText = "âŒ ä¿¡ç®±æ ¼å¼ä¸æ­£ç¢ºã€‚"; return;
        }

        btn.disabled = true; btn.innerText = "å‚³é€ä¸­...";
        statusDiv.style.display = 'block'; statusDiv.style.color = '#0056b3'; statusDiv.innerText = "â³ æ­£æ ¹æ“šæ‚¨çš„å¹´é½¡èª¿æ´¾å°ˆå±¬ç™½çš®æ›¸...";

        try {
            await fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: "send_email", name, email, age, scores: currentData, total: currentData.reduce((a,b)=>a+b,0) }),
                mode: 'no-cors'
            });
            setTimeout(() => {
                statusDiv.style.color = '#28a745';
                statusDiv.innerText = "âœ… å·²é ç´„ç™¼é€ï¼è«‹è‡³æ‚¨çš„ä¿¡ç®±æŸ¥çœ‹ã€Šé€€ä¼‘ç™½çš®æ›¸ã€‹ã€‚";
                btn.innerText = "ç™¼é€æˆåŠŸ";
            }, 1200);
        } catch (e) {
            btn.disabled = false; btn.innerText = "é‡æ–°ç™¼é€";
        }
    }

    function createChart(canvasId, data, isPdf) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        return new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['è²¡å‹™', 'å¥åº·', 'ç¤¾äº¤', 'äººç”Ÿ'],
                datasets: [{ data: data, backgroundColor: 'rgba(0,86,179,0.2)', borderColor: '#0056b3', borderWidth: 2, pointBackgroundColor: '#0056b3' }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                animation: isPdf ? false : { duration: 1000 },
                scales: { r: { suggestedMin: 0, suggestedMax: 25, ticks: { display: false } } },
                plugins: { legend: { display: false } }
            }
        });
    }

    async function processPDF() {
        document.getElementById('loadingOverlay').style.display = 'block';
        window.scrollTo(0, 0);
        const originalWidth = document.body.style.width;
        
        try {
            document.body.style.width = '794px';
            document.getElementById('mobileAppLayer').style.display = 'none';
            document.getElementById('pdfPrintLayer').style.display = 'block';

            if(pdfChart) pdfChart.destroy();
            await new Promise(r => setTimeout(r, 100));
            pdfChart = createChart('pdfRadarChart', currentData, true);
            await new Promise(r => setTimeout(r, 1000)); // ç¢ºä¿é‡ç¹ª

            const opt = {
                margin: 0, filename: `é€€ä¼‘å ±å‘Š_${Date.now()}.pdf`, image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, windowWidth: 794 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            const isPhone = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            if (isPhone) {
                const blob = await html2pdf().set(opt).from(document.getElementById('pdfPrintLayer')).output('blob');
                const file = new File([blob], opt.filename, { type: "application/pdf" });
                restoreUI(originalWidth);
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({ files: [file], title: 'æ‚¨çš„è¨ºæ–·å ±å‘Š' });
                } else {
                    document.getElementById('blobDownloadLink').href = URL.createObjectURL(blob);
                    document.getElementById('mobileDownloadModal').style.display = 'flex';
                }
            } else {
                await html2pdf().set(opt).from(document.getElementById('pdfPrintLayer')).save();
                restoreUI(originalWidth);
            }
        } catch (e) {
            alert('PDF è£½ä½œç•°å¸¸ï¼š' + e.message); restoreUI(originalWidth);
        }
    }

    function restoreUI(width) {
        document.body.style.width = width || '';
        document.getElementById('pdfPrintLayer').style.display = 'none';
        document.getElementById('mobileAppLayer').style.display = 'block';
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    function closeModal() { document.getElementById('mobileDownloadModal').style.display = 'none'; }
    init();
</script>
</body>
</html>
